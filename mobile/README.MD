# ğŸ“± Quartinho-PS Mobile

Bem-vindo(a)! ğŸ‘‹
Este Ã© o aplicativo **Flutter** do **Quartinho-PS**, que consome a API Django e usa **WebSockets via Daphne** para chat em tempo real.

Agora o backend pode ser configurado dinamicamente com:

```bash
--dart-define=BACKEND_HOST=http://SEU_IP:8000
```

sem precisar editar o cÃ³digo.

---

## ğŸš¨ **ATENÃ‡ÃƒO: ARQUIVO ESSENCIAL**

> âš ï¸ **Verifique sempre o arquivo:**
> **`mobile/lib/core/constants.dart`**

ğŸ“ Esse arquivo define **qual URL o app usa para o backend** (API + WebSocket).
Ele detecta automaticamente se estÃ¡ no **emulador, navegador ou celular fÃ­sico**, mas:

* Se algo der errado na conexÃ£o, **confira se o IP e a porta estÃ£o corretos**;
* Ã‰ nele que ficam as constantes `_hostLan`, `_hostAndroidEmu`, `_hostWeb` etc.

ğŸ’¡ **Dica:**
Se mudar de rede Wi-Fi ou usar outro computador, atualize o IP lÃ¡ ou use `--dart-define`.

---

## ğŸ§© PrÃ©-requisitos

* **Flutter SDK** ([guia oficial](https://docs.flutter.dev/get-started/install))
* **Backend Django rodando com Daphne**
* Celular e computador conectados na **mesma rede Wi-Fi**

---

## âš™ï¸ Passos para rodar o app

### 1ï¸âƒ£ Descubra o IP da sua mÃ¡quina

No PowerShell (Windows):

```bash
ipconfig
```

Procure o campo (exemplo):

```
EndereÃ§o IPv4 . . . . . . . . . . . : 192.168.xx.xxx
```

---

### 2ï¸âƒ£ Configure o host do backend (sem editar cÃ³digo)

Use `--dart-define=BACKEND_HOST` para informar o IP/porta:

| Ambiente                   | Comando                                                                  |
| -------------------------- | ------------------------------------------------------------------------ |
| **Android Emulador**       | `flutter run --dart-define=BACKEND_HOST=http://10.0.2.2:8000`            |
| **Celular FÃ­sico (Wi-Fi)** | `flutter run --dart-define=BACKEND_HOST=http://192.168.xx.xxx:8000`      |
| **Web (Chrome)**           | `flutter run -d chrome --dart-define=BACKEND_HOST=http://127.0.0.1:8000` |

> ğŸ’¡ VocÃª nÃ£o precisa usar `-d emulator-5554` se o Flutter jÃ¡ detectar o dispositivo automaticamente.

---

### 3ï¸âƒ£ Conecte o dispositivo

* **Android:** ative a **DepuraÃ§Ã£o USB** e aceite a conexÃ£o.
* **iOS:** use um **Mac com Xcode**.

---

### 4ï¸âƒ£ PermissÃ£o de internet (Android)

Em `android/app/src/main/AndroidManifest.xml`, confirme:

```xml
<uses-permission android:name="android.permission.INTERNET"/>
```

---

### 5ï¸âƒ£ Rode o backend com **Daphne (ASGI)**

O chat usa WebSockets â€” por isso **nÃ£o use `runserver`**.

```bash
cd backend
.venv\Scripts\Activate.ps1
daphne -b 0.0.0.0 -p 8000 backend.asgi:application
```

> âš ï¸ Se rodar com `python manage.py runserver`, o chat **nÃ£o funcionarÃ¡** (WebSocket falharÃ¡).

---

### 6ï¸âƒ£ Execute o app Flutter

```bash
cd mobile
flutter pub get
flutter run
```

Troque o IP conforme necessÃ¡rio se estiver em celular fÃ­sico.

---

## ğŸ’¬ WebSocket (Chat)

* O app converte automaticamente `http://` â†’ `ws://`
* Endpoint usado:

  ```
  /ws/chat/?token=JWT_TOKEN
  ```
* O backend **precisa estar rodando com Daphne**

Se ocorrer `"Connection reset by peer"`:

* âœ… Verifique se o Daphne estÃ¡ ativo
* âœ… Confirme o IP em `--dart-define`
* âœ… Celular e PC estÃ£o na **mesma rede**
* âœ… Firewall nÃ£o bloqueia a porta 8000

---

## ğŸ§  Dicas Ãºteis

* Teste o backend direto no celular:

  ```
  http://192.168.xx.xxx:8000/api/
  ```
* **Emulador Android:** `http://10.0.2.2:8000`
* **Celular fÃ­sico:** `http://192.168.xx.xxx:8000`
* No Django `settings.py`:

  ```python
  ALLOWED_HOSTS = ['*']
  CORS_ALLOW_ALL_ORIGINS = True
  ```

---

## ğŸ› Erros comuns

| Erro                              | Causa                          | SoluÃ§Ã£o                                                       |
| --------------------------------- | ------------------------------ | ------------------------------------------------------------- |
| âŒ *â€œWebSocket connection failedâ€* | Usando `runserver`             | Rode com `daphne -b 0.0.0.0 -p 8000 backend.asgi:application` |
| âŒ *â€œConnection refusedâ€*          | IP errado no Flutter           | Corrija `--dart-define=BACKEND_HOST=http://SEU_IP:8000`       |
| âŒ *â€œUser not authenticatedâ€*      | Token JWT invÃ¡lido             | Refazer login                                                 |
| âŒ *â€œDisallowedHostâ€*              | IP nÃ£o estÃ¡ em `ALLOWED_HOSTS` | Adicione `'*'` no settings                                    |

---

## ğŸš€ ExecuÃ§Ã£o RÃ¡pida (TL;DR)

```bash
# Backend
cd backend
.venv\Scripts\Activate.ps1
daphne -b 0.0.0.0 -p 8000 backend.asgi:application

# Mobile
cd mobile
flutter pub get
flutter run --dart-define=BACKEND_HOST=http://192.168.xx.xxx:8000
```
